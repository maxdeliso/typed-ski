name: Publish to JSR and Crates.io

on:
  push:
    branches:
      - main

permissions:
  contents: read
  id-token: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v25

      - name: Update version and generate files
        run: |
          nix run .#update-version
          nix run .#generate-cargo
          nix run .#generate-version-ts

      - name: Build with Nix
        run: nix build

      - name: Copy WASM files for tests
        run: |
          mkdir -p wasm
          cp result/wasm/*.wasm wasm/

      - name: Embed WASM bytes
        run: nix --extra-experimental-features 'nix-command flakes' develop --command deno run -A scripts/embed-wasm.ts

      - name: Build dist files for tests
        run: |
          set -e
          export PATH="$(nix --extra-experimental-features 'nix-command flakes' develop --command bash -c 'echo $PATH'):$PATH"
          nix --extra-experimental-features 'nix-command flakes' develop --command bash -c "deno task dist"
          echo "Dist files build completed"

      - name: Validate dist files
        run: |
          echo "Checking for required dist files..."
          ls -lh dist/ || echo "dist/ directory does not exist"
          test -f dist/tripc.js || (echo "ERROR: dist/tripc.js not found" && exit 1)
          test -f dist/tripc.min.js || (echo "ERROR: dist/tripc.min.js not found" && exit 1)
          test -f dist/tripc || (echo "ERROR: dist/tripc binary not found" && exit 1)
          echo "All required dist files exist:"
          ls -lh dist/tripc.js dist/tripc.min.js dist/tripc

      - name: Run Rust tests
        run: nix run .#test-rust

      - name: Check formatting
        run: nix run .#fmt -- --check

      - name: Lint
        run: nix run .#lint

      - name: Run Deno tests
        run: nix run .#test

      - name: Publish to JSR (Deno Registry)
        run: nix run .#publish

      - name: Authenticate with crates.io (Trusted Publishing)
        id: auth
        uses: rust-lang/crates-io-auth-action@v1

      - name: Publish to crates.io
        run: |
          echo "Using Cargo from: $(nix --extra-experimental-features 'nix-command flakes' develop --command which cargo)"
          nix --extra-experimental-features 'nix-command flakes' develop --command bash -c "cd rust && cargo publish"
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.auth.outputs.token }}
