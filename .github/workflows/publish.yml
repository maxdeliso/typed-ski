name: Publish to JSR and Crates.io

on:
  push:
    branches:
      - main

permissions:
  contents: read
  id-token: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v25

      - name: Verify Nix-provided tools
        run: |
          echo "Verifying tools are from Nix:"
          echo "Deno: $(which deno || echo 'not found')"
          echo "Cargo: $(which cargo || echo 'not found')"
          echo "Rustc: $(which rustc || echo 'not found')"
          echo ""
          echo "Entering Nix development shell to ensure tools are available..."
          nix develop --command bash -c "
            echo 'Tools in Nix environment:'
            which deno && deno --version
            which cargo && cargo --version
            which rustc && rustc --version
          "

      - name: Update version and generate Cargo.toml
        run: |
          nix run .#update-version
          nix run .#generate-cargo

      - name: Build with Nix
        run: nix build

      - name: Run Rust tests
        run: nix run .#test-rust

      - name: Check formatting
        run: nix run .#fmt -- --check

      - name: Lint
        run: nix run .#lint

      - name: Upload WASM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wasm-files
          path: result/wasm/
          retention-days: 30

      - name: Upload dist artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-files
          path: dist/
          retention-days: 30

      - name: Publish to JSR (Deno Registry)
        run: nix run .#publish

      - name: Authenticate with crates.io (Trusted Publishing)
        id: auth
        uses: rust-lang/crates-io-auth-action@v1

      - name: Publish to crates.io
        run: |
          echo "Using Cargo from: $(nix --extra-experimental-features 'nix-command flakes' develop --command which cargo)"
          nix --extra-experimental-features 'nix-command flakes' develop --command bash -c "cd rust && cargo publish"
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.auth.outputs.token }}
